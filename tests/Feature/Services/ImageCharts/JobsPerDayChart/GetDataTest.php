<?php

namespace Tests\Feature\Services\ImageCharts\JobsPerDayChart;

use Carbon\Carbon;
use Illuminate\Foundation\Testing\RefreshDatabase;
use SkrdIo\JobsOverview\Models\JobConclusion;
use SkrdIo\JobsOverview\Services\ImageCharts\JobsPerDayChart;
use Tests\TestCase;

class GetDataTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();

        Carbon::setTestNow(Carbon::create(2001, 5, 21, 12));
    }

    public function testZeroConclusions(): void
    {
        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [0, 0],
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testConcludedToday(): void
    {
        factory(JobConclusion::class)->create([
            'concluded_at' => Carbon::now(),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [0, 0],
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testConcludedYesterday(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDay(),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [0, 0],
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [1, 0], // 👈
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testConcluded31DaysAgo(): void
    {
        factory(JobConclusion::class)->create([
            'concluded_at' => Carbon::now()->subDays(31),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [0, 0],
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testConcluded30DaysAgo(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(30),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [1, 0], // 👈
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [0, 0],
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testSingleSuccessfulConclusion(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [1, 0], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testSingleFailedConclusion(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => true,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [0, 1], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testMultipleConclusionsOnSameDay(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        factory(JobConclusion::class)->create([
            'is_fail' => true,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [1, 1], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testMultipleSuccessfulConclusionsOnSameDay(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [2, 0], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testMultipleFailedConclusionsOnSameDay(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => true,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        factory(JobConclusion::class)->create([
            'is_fail' => true,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 0],
                '2001-05-06' => [0, 2], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testMultipleConclusionsOnDifferentDays(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => true,
            'concluded_at' => Carbon::now()->subDays(16),
        ]);

        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 1], // 👈
                '2001-05-06' => [1, 0], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testMultipleSuccessfulConclusionsOnDifferentDays(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(16),
        ]);

        factory(JobConclusion::class)->create([
            'is_fail' => false,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [1, 0], // 👈
                '2001-05-06' => [1, 0], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }

    public function testMultipleFailedConclusionsOnDifferentDays(): void
    {
        factory(JobConclusion::class)->create([
            'is_fail' => true,
            'concluded_at' => Carbon::now()->subDays(16),
        ]);

        factory(JobConclusion::class)->create([
            'is_fail' => true,
            'concluded_at' => Carbon::now()->subDays(15),
        ]);

        $this->assertSame(
            [
                '2001-04-21' => [0, 0],
                '2001-04-22' => [0, 0],
                '2001-04-23' => [0, 0],
                '2001-04-24' => [0, 0],
                '2001-04-25' => [0, 0],
                '2001-04-26' => [0, 0],
                '2001-04-27' => [0, 0],
                '2001-04-28' => [0, 0],
                '2001-04-29' => [0, 0],
                '2001-04-30' => [0, 0],
                '2001-05-01' => [0, 0],
                '2001-05-02' => [0, 0],
                '2001-05-03' => [0, 0],
                '2001-05-04' => [0, 0],
                '2001-05-05' => [0, 1], // 👈
                '2001-05-06' => [0, 1], // 👈
                '2001-05-07' => [0, 0],
                '2001-05-08' => [0, 0],
                '2001-05-09' => [0, 0],
                '2001-05-10' => [0, 0],
                '2001-05-11' => [0, 0],
                '2001-05-12' => [0, 0],
                '2001-05-13' => [0, 0],
                '2001-05-14' => [0, 0],
                '2001-05-15' => [0, 0],
                '2001-05-16' => [0, 0],
                '2001-05-17' => [0, 0],
                '2001-05-18' => [0, 0],
                '2001-05-19' => [0, 0],
                '2001-05-20' => [0, 0],
            ],
            (new JobsPerDayChart())->getData()
        );
    }
}
